---
title:  "Azure-to-AWS"
layout: post
categories: tech
---

This article aims to provide a quick guide to connect a cloud native site-to-site VPN between Azure and AWS. Both environments will be greenfield deployments. Due to the VPN configuration requirements of both platforms we will be jumping back and forth between AWS and Azure to get as some steps require information generated by the other.

* Azure resources
    * [VPN Gateway](https://azure.microsoft.com/en-us/services/vpn-gateway/#overview)
    * [Resource Group](https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-portal#what-is-a-resource-group)
    * [Virtual Network](https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview)
        * [Subnet](https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-manage-subnet#add-a-subnet)
    * [Public IP](https://docs.microsoft.com/en-us/azure/virtual-network/public-ip-addresses)
* AWS
    * [VPC](https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html)
        * [Subnet](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html)
    * [Route Tables](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Route_Tables.html)
    * [Customer Gateways](https://docs.aws.amazon.com/vpn/latest/s2svpn/your-cgw.html)
    * [Virtual Private Gateways](https://docs.aws.amazon.com/directconnect/latest/UserGuide/virtualgateways.html)
    * [Site-to-Site VPN Connections](https://docs.aws.amazon.com/vpn/latest/s2svpn/SetUpVPNConnections.html)
    * [Security Groups](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/working-with-security-groups.html)

# Azure
The first thing that you'll want to deploy is the Azure Virtual Network Gateway (VNG). The average deployment takes about 30 minutes. Keep in mind this is a free service on the Azure Students subscription. If you wanted to learn more about a VPN Gateway [click here](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways?WT.mc_id=Portal-Microsoft_Azure_HybridNetworking).

## Create virtual network gateway
* Navigate to the [Azure Portal](portal.azure.com)

![1-search-vng.png](Thor-DraperJr.github.io\assets\images\1-search-vng.png)

* Search for and select `Virtual network gateway` once the page opens press create
    * One first tab you'll see you are on the `Basics` page
        * Subscription: [YOUR-SUBSCRIPTION]
        * Resource Group: [YOUR-RESOURCEGRUP]
        ---
        * **Instance details**
        * Name: VpnGw
        * Region: East US 2
        * Gateway Type: VPN
        * VPN type: Route-based
        * Generation: Generation2
        * Virtual Network: Create virtual network
            * Name: vNet-1
            * Resource Group: rg-1
            * Address space: 10.0.0.0/16
            * Subnets:
                * default: 10.0.0.0/24
        * *Gateway subnet address range: 10.0.1.0/24* <---This option will populate once you create the vNet
    * **Public IP address**
        * Public IP address: Create new
        * Public IP address name: VpnGw-PublicIp
        * Public IP address SKU: Basic
        * Assignment: Dynamic
        * Enabled active-active: Disabled
        * Configure BGP: Disabled

First we've created a Resource Group, the container that holds related resources for an Azure solution. We've also created a vNet in the 10.0.0.0/16 address space as well as a dedicated GatewaySubnet. Currently, we've left the BGP seelctor disabled. We'll configure BGP after we've created our AWS resources.

Before leaving the Azure platform you should see the Public IP address created fairly quickly.
# AWS
In AWS the first thing that you'll create is an Amazon Virtual Private Cloud (VPC) and use the launch wizard. 

* Navigate to your [AWS Console](console.aws.amazon.com).

![2](Thor-DraperJr.github.io\assets\images\2-blank-vng.png)

* Search for and select `VPC` once the page opens press `Launch VPC Wizard`
    * Step 1: Select a VPC Configuration
        * Select the fourth option: VPC with a Private Subnet Only and Hardware VPN Access
    * Step 2: VPC with a Private Subnet Only and Hardware VPN Access
        * IPv4 CIDR block: 172.16.0.0/16
        * IPv6 CIDR block: No IPv6 CIDR Block
        * VPC name: vpc-1
        ---
        * Private subnet's IPv4 CIDR: 172.16.0.0/24
        * Availability Zone: No Preference
        * Private subnet name: Private subnet
        ---
        Service endpoints: Left blank
        ---
        * Enable DNS hostnames: Yes
        * Hardware tenancy: Default
    * Step 3:
        * Customer Gateway IP:[AZURE-PUBLIC-IP] <--- From the Azure VNG
        * Customer Gateway name: Azure
        * VPN Connection name: AWS-to-Azure
        ---
        * Routing Type: Dynamic (requires BGP)

Once our resources are created we'll want to stay on the VPC page and used the left pane and navigate to the Site-to-Site VPN Connection. The two things we need to accomplish here are changing the inside tunnel addresses and download our configuration and tunnel information.

* VIRTUAL PRIVATE NETWORK > Site-to-Site VPN Connections
    * Right click on your newly created VPN Connection and select `Modify VPN Tunnel Options`
        * Select Tunnel 1
            * Inside IPv4 CIDR: 169.254.21.0/30
            * All other options can be left to their defaults

![5](Thor-DraperJr.github.io\assets\images\5-s2s-modify-vpn-tunnel.png)

Azure BGP IP in the ranges `169.254.21.*` and `169.254.22.*` while AWS makes you create a /30 CIDR in the 169.254.0.0/16 range. Your tunnel is automatically pull the first address in the range, in our instance it will be `169.254.21.1`.

* Back on the Site-to-Site VPN connection page press `Download Configuration`
    * Vendor: Generic
    * Platform: Generic
    * Software: Vendor Agnostic

From the downloaded .txt file you'll want to take note of the following information:
* For IPSec Tunnel #1
    * Pre-Shared Key (Line 36): GENERATED-BY-AMAZON
    * Outside IP Addresses:
        * Virtual Private Gateway(Line 94): GENERATED-BY-AMAZON
    * Customer Gateway ASN (Line 111): 65000
    * Virtual Private  Gateway ASN (Line 112): 64512
    * Neighbor IP Address (Line 113): 169.254.21.1
* For IPSec Tunnel #2
    * Pre-Shared Key (Line 138): GENERATED-BY-AMAZON
    * Outside IP Addresses:
        * Virtual Private Gateway (Line 196): GENERATED-BY-AMAZON
    * Customer Gateway ASN (Line 213): 65000
    * Virtual Private  Gateway ASN (Line 214): 64512
    * Neighbor IP Address (Line 215): 169.254.22.1

Take note of this information in case your side anything was assigned differently.

# Azure (Part 2)
* Navigate to the [Azure Portal](portal.azure.com)
* Search for and select `Local network gateways` once the page opens press create
    * Local network gateway
        * Create local network gateway
            * Name: Aws-Tunnel-1
            * Endpoint: IP address
            * IP address: OUTSIDE-VPG-IP<---found in the config file [Interface #1]
            * Address space: LEFT BLANK
            * Check the box to `Configure BGP settings`
                * Autonomous system number (ASN): 64512 <--- found in the config file [VPG ASN]
            * Subscription: YOURSUBSCRIPTION
            * Resource group: rg-1
            * Location EastUs2
        * Create local network gateway
            * Name: Aws-Tunnel-2
            * Endpoint: IP address
            * IP address: OUTSIDE-VPG-IP<---found in the config file [Interface #2]
            * Address space: LEFT BLANK
            * Check the box to `Configure BGP settings`
                * Autonomous system number (ASN): 64512 <--- found in the config file [VPG ASN]
            * Subscription: YOURSUBSCRIPTION
            * Resource group: rg-1
            * Location EastUs2

* Search for and select `Virtual Network Gateways`
    * Located on the left menu under Settings choose `Configuration`
        * Check the box to `Configure BGP`
            * Autonomous system number (ASN): 65000 <--- found in the config file [Customer Gateway ASN]
            * Custom Azure APIPA BGP IP address: 169.254.21.2 <--- the next available IP in the /30 in Azure
    * Next, located on the left menu under Settings choose Connections
        * Select Add
            * Name: Azure-to-Aws
            * Connection type: Site-to-site (IPsec)
            * Virtual network gateway: EastUs2-Free-VpnGw
            * Local network gateway: Aws-Tunnel-1
            * Shared key (PSK): GENERATED-FROM-AWS <--- found in the config file [PSK]
            * Check the box to `Enable BGP`

In order to utilize both tunnels in order to make this a redundant connection you'd need to create another Basic SKU Dynamic Public IP. In your AWS portal be sure to change Tunnel #2 to another /30 within the accepted Azure APIPA range.

# Troubleshooting
A few areas to check for troubleshooting.
* Verify that you Route Tables are enabling Route propogation.
* If you are trying to ping a resource in AWS make sure that you have the Inbound rule for the subnet of the resource to allow ICMP traffic.

# Final Thoughts